# AI虚拟试衣应用 - 技术实现指南

## 1. 项目结构设计

### 1.1 前端项目结构
```
src/
├── components/           # 可复用组件
│   ├── common/          # 通用组件
│   │   ├── Button/
│   │   ├── Modal/
│   │   ├── Loading/
│   │   └── ImageUpload/
│   ├── layout/          # 布局组件
│   │   ├── Header/
│   │   ├── Footer/
│   │   └── Sidebar/
│   └── features/        # 功能组件
│       ├── ImageCapture/
│       ├── AISettings/
│       ├── ResultPreview/
│       └── BackgroundSelector/
├── pages/               # 页面组件
│   ├── Home/
│   ├── TryOn/
│   └── Gallery/
├── hooks/               # 自定义Hooks
│   ├── useImageUpload.ts
│   ├── useAISettings.ts
│   └── useTryOnResult.ts
├── services/            # API服务
│   ├── api.ts
│   ├── auth.ts
│   └── tryon.ts
├── store/               # 状态管理
│   ├── slices/
│   │   ├── authSlice.ts
│   │   ├── tryonSlice.ts
│   │   └── uiSlice.ts
│   └── store.ts
├── utils/               # 工具函数
│   ├── imageUtils.ts
│   ├── validation.ts
│   └── constants.ts
├── types/               # TypeScript类型定义
│   ├── api.ts
│   ├── user.ts
│   └── tryon.ts
└── styles/              # 样式文件
    ├── globals.css
    └── components.css
```

### 1.2 后端项目结构
```
src/
├── controllers/         # 控制器
│   ├── authController.ts
│   ├── userController.ts
│   └── tryonController.ts
├── services/            # 业务逻辑
│   ├── authService.ts
│   ├── userService.ts
│   ├── tryonService.ts
│   └── aiService.ts
├── models/              # 数据模型
│   ├── User.ts
│   ├── TryOnSession.ts
│   └── BackgroundTemplate.ts
├── middleware/          # 中间件
│   ├── auth.ts
│   ├── validation.ts
│   └── errorHandler.ts
├── routes/              # 路由定义
│   ├── auth.ts
│   ├── users.ts
│   └── tryon.ts
├── utils/               # 工具函数
│   ├── database.ts
│   ├── storage.ts
│   └── aiUtils.ts
├── config/              # 配置文件
│   ├── database.ts
│   ├── redis.ts
│   └── ai.ts
└── types/               # 类型定义
    ├── express.d.ts
    └── global.d.ts
```

## 2. 核心功能实现

### 2.1 图像上传组件实现

```typescript
// components/features/ImageCapture/ImageUpload.tsx
import React, { useState, useCallback } from 'react';
import { useDropzone } from 'react-dropzone';
import { uploadImage, validateImage } from '@/services/api';

interface ImageUploadProps {
  type: 'user' | 'clothing';
  onUploadSuccess: (url: string) => void;
  onUploadError: (error: string) => void;
}

export const ImageUpload: React.FC<ImageUploadProps> = ({
  type,
  onUploadSuccess,
  onUploadError
}) => {
  const [uploading, setUploading] = useState(false);
  const [preview, setPreview] = useState<string | null>(null);

  const onDrop = useCallback(async (acceptedFiles: File[]) => {
    const file = acceptedFiles[0];
    if (!file) return;

    // 图像验证
    const validation = await validateImage(file, type);
    if (!validation.valid) {
      onUploadError(validation.error);
      return;
    }

    setUploading(true);
    try {
      const result = await uploadImage(file, type);
      setPreview(result.previewUrl);
      onUploadSuccess(result.imageUrl);
    } catch (error) {
      onUploadError('上传失败，请重试');
    } finally {
      setUploading(false);
    }
  }, [type, onUploadSuccess, onUploadError]);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'image/*': ['.jpeg', '.jpg', '.png', '.webp']
    },
    maxSize: 10 * 1024 * 1024, // 10MB
    multiple: false
  });

  return (
    <div className="upload-area">
      <div
        {...getRootProps()}
        className={`upload-card rounded-xl p-6 flex flex-col h-full justify-center items-center cursor-pointer ${
          isDragActive ? 'border-blue-500 bg-blue-50' : ''
        }`}
      >
        <input {...getInputProps()} />
        <div className="text-center mb-4">
          <span className="iconify text-4xl text-gray-400" data-icon="clarity:upload-line"></span>
        </div>
        <h3 className="text-lg font-medium mb-2 text-gray-700">
          {type === 'user' ? '上传人物照片' : '上传服装图片'}
        </h3>
        <p className="text-gray-500 text-center mb-4 max-w-xs">
          {type === 'user' 
            ? '上传您的正面全身照，确保光线充足、背景简单'
            : '选择您想试穿的服装图片，支持多种衣物类型'
          }
        </p>
        {uploading ? (
          <div className="flex items-center">
            <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
            <span className="ml-2 text-blue-500">上传中...</span>
          </div>
        ) : (
          <button className="btn-secondary rounded-lg cursor-pointer">
            选择文件
          </button>
        )}
        <p className="text-xs text-gray-400 mt-3">支持 JPG、PNG 格式，最大 10MB</p>
      </div>
      
      {preview && (
        <div className="mt-6">
          <div className="flex justify-between items-center mb-4">
            <h4 className="font-medium text-gray-700">照片预览</h4>
            <button 
              className="text-sm text-blue-500 hover:underline"
              onClick={() => setPreview(null)}
            >
              更换
            </button>
          </div>
          <div className="preview-container p-2">
            <img 
              src={preview} 
              alt="Preview" 
              className="w-full h-64 object-contain rounded-lg"
            />
          </div>
        </div>
      )}
    </div>
  );
};
```

### 2.2 AI设置组件实现

```typescript
// components/features/AISettings/AISettingsPanel.tsx
import React, { useState } from 'react';
import { useAppDispatch, useAppSelector } from '@/store/hooks';
import { updateAISettings } from '@/store/slices/tryonSlice';

interface AISettings {
  fittingStyle: 'loose' | 'standard' | 'tight';
  effectIntensity: 'natural' | 'enhanced' | 'fashion' | 'none';
}

export const AISettingsPanel: React.FC = () => {
  const dispatch = useAppDispatch();
  const { aiSettings } = useAppSelector(state => state.tryon);
  
  const [settings, setSettings] = useState<AISettings>(aiSettings);

  const handleFittingStyleChange = (style: AISettings['fittingStyle']) => {
    const newSettings = { ...settings, fittingStyle: style };
    setSettings(newSettings);
    dispatch(updateAISettings(newSettings));
  };

  const handleEffectIntensityChange = (intensity: AISettings['effectIntensity']) => {
    const newSettings = { ...settings, effectIntensity: intensity };
    setSettings(newSettings);
    dispatch(updateAISettings(newSettings));
  };

  const fittingStyleOptions = [
    { value: 'loose', label: '宽松款' },
    { value: 'standard', label: '标准款' },
    { value: 'tight', label: '修身款' }
  ];

  const effectOptions = [
    { value: 'natural', label: '自然效果' },
    { value: 'enhanced', label: '增强光影 (推荐)' },
    { value: 'fashion', label: '时尚大片效果' },
    { value: 'none', label: '无特效' }
  ];

  return (
    <section className="mb-16 border-t border-gray-200 pt-16">
      <div className="flex items-center mb-8">
        <h2 className="section-title">AI处理设置</h2>
        <div className="ml-4 bg-blue-50 text-blue-700 text-sm px-3 py-1 rounded-full">
          步骤 2/4
        </div>
      </div>
      
      <div className="flex space-x-6 mb-8">
        <div className="flex-1">
          <label className="block text-gray-700 font-medium mb-2">服装贴合度</label>
          <div className="flex space-x-4">
            {fittingStyleOptions.map((option) => (
              <button
                key={option.value}
                onClick={() => handleFittingStyleChange(option.value as AISettings['fittingStyle'])}
                className={`rounded-lg px-4 py-2 flex-1 text-center transition-all ${
                  settings.fittingStyle === option.value
                    ? 'btn-primary font-medium'
                    : 'btn-secondary'
                }`}
              >
                {option.label}
              </button>
            ))}
          </div>
        </div>
        
        <div className="flex-1">
          <label className="block text-gray-700 font-medium mb-2">特效强度</label>
          <select
            value={settings.effectIntensity}
            onChange={(e) => handleEffectIntensityChange(e.target.value as AISettings['effectIntensity'])}
            className="w-full border border-gray-300 rounded-lg px-4 py-3 bg-white focus:border-blue-500 focus:outline-none"
          >
            {effectOptions.map((option) => (
              <option key={option.value} value={option.value}>
                {option.label}
              </option>
            ))}
          </select>
        </div>
      </div>
    </section>
  );
};
```

### 2.3 试衣结果展示组件

```typescript
// components/features/ResultPreview/ResultPreview.tsx
import React, { useState, useEffect } from 'react';
import { useAppSelector } from '@/store/hooks';
import { generateTryOnResult } from '@/services/tryon';

export const ResultPreview: React.FC = () => {
  const { userImage, clothingImage, aiSettings, backgroundType } = useAppSelector(state => state.tryon);
  const [result, setResult] = useState<string | null>(null);
  const [processing, setProcessing] = useState(false);
  const [progress, setProgress] = useState(0);

  const handleGenerateResult = async () => {
    if (!userImage || !clothingImage) {
      alert('请先上传用户照片和服装图片');
      return;
    }

    setProcessing(true);
    setProgress(0);

    try {
      const result = await generateTryOnResult({
        userImage,
        clothingImage,
        aiSettings,
        backgroundType,
        onProgress: (progress) => setProgress(progress)
      });
      
      setResult(result.imageUrl);
    } catch (error) {
      console.error('生成试衣结果失败:', error);
      alert('生成失败，请重试');
    } finally {
      setProcessing(false);
      setProgress(0);
    }
  };

  return (
    <section className="mb-16 border-t border-gray-200 pt-16">
      <div className="flex items-center justify-between mb-8">
        <h2 className="section-title">试衣效果预览</h2>
        <div className="flex items-center space-x-4">
          <span className="text-gray-500 font-medium">全屏查看</span>
          <button className="p-3 bg-gray-100 rounded-full hover:bg-gray-200">
            <span className="iconify text-xl" data-icon="material-symbols:fit-screen-outline-rounded"></span>
          </button>
        </div>
      </div>

      <div className="grid grid-cols-3 gap-8">
        <div className="col-span-2">
          <div className="preview-container h-[500px] relative">
            {processing ? (
              <div className="flex flex-col items-center justify-center h-full">
                <div className="w-16 h-16 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                <p className="text-gray-600 mb-2">AI正在生成试衣效果...</p>
                <div className="w-64 bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${progress}%` }}
                  ></div>
                </div>
                <p className="text-sm text-gray-500 mt-2">{progress}%</p>
              </div>
            ) : result ? (
              <>
                <div className="absolute top-4 left-4 z-10 bg-white/80 rounded-full backdrop-blur flex px-4 py-2 text-blue-700">
                  <span className="iconify mr-2" data-icon="fluent-emoji-high-contrast:sparkles"></span>
                  <span className="font-medium">AI智能生成效果</span>
                </div>
                <img 
                  src={result} 
                  alt="AI-generated outfit preview" 
                  className="w-full h-full object-contain"
                />
                <div className="absolute bottom-4 left-0 right-0 flex justify-center">
                  <div className="bg-white rounded-lg flex items-center py-2 px-4 shadow-md">
                    <span className="mr-2">处理状态: 完成</span>
                    <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                  </div>
                </div>
              </>
            ) : (
              <div className="flex flex-col items-center justify-center h-full text-gray-500">
                <span className="iconify text-6xl mb-4" data-icon="mdi:image-outline"></span>
                <p className="text-lg mb-2">暂无试衣效果</p>
                <p className="text-sm">请先上传照片并生成试衣效果</p>
              </div>
            )}
          </div>
        </div>

        <div>
          <div className="mb-8">
            <h3 className="font-bold text-gray-700 mb-5">选择背景环境</h3>
            <div className="grid grid-cols-2 gap-4">
              {/* 背景选择组件 */}
            </div>
          </div>

          <div className="border border-gray-200 rounded-lg p-4">
            <h3 className="font-bold text-gray-700 mb-3">AI增强选项</h3>
            <div className="space-y-2">
              <label className="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" className="rounded text-blue-600" defaultChecked />
                <span>显示服装材质细节</span>
              </label>
              <label className="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" className="rounded text-blue-600" defaultChecked />
                <span>智能光影合成</span>
              </label>
              <label className="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" className="rounded text-blue-600" />
                <span>模拟动态效果</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      {!processing && (
        <div className="flex justify-center mt-8">
          <button 
            onClick={handleGenerateResult}
            className="btn-primary rounded-full py-4 px-10 text-lg font-bold"
            disabled={!userImage || !clothingImage}
          >
            <span className="iconify align-middle mr-3" data-icon="solar:magic-stick-bold"></span>
            生成试衣效果
          </button>
        </div>
      )}
    </section>
  );
};
```

## 3. API服务实现

### 3.1 试衣服务API

```typescript
// services/tryon.ts
import { api } from './api';

export interface TryOnRequest {
  userImage: string;
  clothingImage: string;
  aiSettings: {
    fittingStyle: 'loose' | 'standard' | 'tight';
    effectIntensity: 'natural' | 'enhanced' | 'fashion' | 'none';
  };
  backgroundType?: string;
}

export interface TryOnResponse {
  sessionId: string;
  status: 'processing' | 'completed' | 'failed';
  resultImageUrl?: string;
  progress?: number;
  error?: string;
}

export const tryonService = {
  // 生成试衣结果
  async generateTryOnResult(
    request: TryOnRequest,
    onProgress?: (progress: number) => void
  ): Promise<{ imageUrl: string }> {
    const response = await api.post<TryOnResponse>('/tryon/generate', request);
    
    // 轮询检查处理状态
    return new Promise((resolve, reject) => {
      const pollStatus = async () => {
        try {
          const statusResponse = await api.get<TryOnResponse>(`/tryon/status/${response.data.sessionId}`);
          
          if (statusResponse.data.progress) {
            onProgress?.(statusResponse.data.progress);
          }
          
          if (statusResponse.data.status === 'completed') {
            resolve({ imageUrl: statusResponse.data.resultImageUrl! });
          } else if (statusResponse.data.status === 'failed') {
            reject(new Error(statusResponse.data.error || '处理失败'));
          } else {
            // 继续轮询
            setTimeout(pollStatus, 2000);
          }
        } catch (error) {
          reject(error);
        }
      };
      
      pollStatus();
    });
  },

  // 获取试衣历史
  async getTryOnHistory(page: number = 1, limit: number = 10) {
    return api.get('/tryon/history', {
      params: { page, limit }
    });
  },

  // 下载试衣结果
  async downloadResult(sessionId: string) {
    return api.get(`/tryon/download/${sessionId}`, {
      responseType: 'blob'
    });
  }
};
```

### 3.2 图像处理服务

```typescript
// services/image.ts
import { api } from './api';

export interface ImageValidationResult {
  valid: boolean;
  error?: string;
  warnings?: string[];
}

export interface UploadResult {
  imageUrl: string;
  previewUrl: string;
  metadata: {
    width: number;
    height: number;
    size: number;
    format: string;
  };
}

export const imageService = {
  // 验证图像
  async validateImage(file: File, type: 'user' | 'clothing'): Promise<ImageValidationResult> {
    // 客户端验证
    if (file.size > 10 * 1024 * 1024) {
      return { valid: false, error: '文件大小不能超过10MB' };
    }

    if (!file.type.startsWith('image/')) {
      return { valid: false, error: '请选择图片文件' };
    }

    // 服务端验证
    const formData = new FormData();
    formData.append('image', file);
    formData.append('type', type);

    try {
      const response = await api.post<ImageValidationResult>('/image/validate', formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      return response.data;
    } catch (error) {
      return { valid: false, error: '图像验证失败' };
    }
  },

  // 上传图像
  async uploadImage(file: File, type: 'user' | 'clothing'): Promise<UploadResult> {
    const formData = new FormData();
    formData.append('image', file);
    formData.append('type', type);

    const response = await api.post<UploadResult>('/image/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
      onUploadProgress: (progressEvent) => {
        const percentCompleted = Math.round(
          (progressEvent.loaded * 100) / (progressEvent.total || 1)
        );
        console.log(`Upload progress: ${percentCompleted}%`);
      }
    });

    return response.data;
  },

  // 获取背景模板
  async getBackgroundTemplates() {
    return api.get('/image/backgrounds');
  }
};
```

## 4. 状态管理实现

### 4.1 Redux Store配置

```typescript
// store/store.ts
import { configureStore } from '@reduxjs/toolkit';
import { authSlice } from './slices/authSlice';
import { tryonSlice } from './slices/tryonSlice';
import { uiSlice } from './slices/uiSlice';

export const store = configureStore({
  reducer: {
    auth: authSlice.reducer,
    tryon: tryonSlice.reducer,
    ui: uiSlice.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: ['persist/PERSIST'],
      },
    }),
});

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

### 4.2 试衣状态管理

```typescript
// store/slices/tryonSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';

interface AISettings {
  fittingStyle: 'loose' | 'standard' | 'tight';
  effectIntensity: 'natural' | 'enhanced' | 'fashion' | 'none';
}

interface TryOnState {
  userImage: string | null;
  clothingImage: string | null;
  resultImage: string | null;
  backgroundType: string | null;
  aiSettings: AISettings;
  processing: boolean;
  progress: number;
  error: string | null;
  history: TryOnSession[];
}

interface TryOnSession {
  id: string;
  userImage: string;
  clothingImage: string;
  resultImage: string;
  createdAt: string;
  aiSettings: AISettings;
}

const initialState: TryOnState = {
  userImage: null,
  clothingImage: null,
  resultImage: null,
  backgroundType: null,
  aiSettings: {
    fittingStyle: 'standard',
    effectIntensity: 'enhanced'
  },
  processing: false,
  progress: 0,
  error: null,
  history: []
};

export const tryonSlice = createSlice({
  name: 'tryon',
  initialState,
  reducers: {
    setUserImage: (state, action: PayloadAction<string>) => {
      state.userImage = action.payload;
      state.error = null;
    },
    setClothingImage: (state, action: PayloadAction<string>) => {
      state.clothingImage = action.payload;
      state.error = null;
    },
    setResultImage: (state, action: PayloadAction<string>) => {
      state.resultImage = action.payload;
      state.processing = false;
      state.progress = 0;
    },
    setBackgroundType: (state, action: PayloadAction<string>) => {
      state.backgroundType = action.payload;
    },
    updateAISettings: (state, action: PayloadAction<Partial<AISettings>>) => {
      state.aiSettings = { ...state.aiSettings, ...action.payload };
    },
    setProcessing: (state, action: PayloadAction<boolean>) => {
      state.processing = action.payload;
      if (action.payload) {
        state.progress = 0;
        state.error = null;
      }
    },
    setProgress: (state, action: PayloadAction<number>) => {
      state.progress = action.payload;
    },
    setError: (state, action: PayloadAction<string>) => {
      state.error = action.payload;
      state.processing = false;
    },
    addToHistory: (state, action: PayloadAction<TryOnSession>) => {
      state.history.unshift(action.payload);
      // 保持历史记录不超过50条
      if (state.history.length > 50) {
        state.history = state.history.slice(0, 50);
      }
    },
    clearTryOn: (state) => {
      state.userImage = null;
      state.clothingImage = null;
      state.resultImage = null;
      state.processing = false;
      state.progress = 0;
      state.error = null;
    }
  }
});

export const {
  setUserImage,
  setClothingImage,
  setResultImage,
  setBackgroundType,
  updateAISettings,
  setProcessing,
  setProgress,
  setError,
  addToHistory,
  clearTryOn
} = tryonSlice.actions;

export default tryonSlice.reducer;
```

## 5. 自定义Hooks实现

### 5.1 图像上传Hook

```typescript
// hooks/useImageUpload.ts
import { useState, useCallback } from 'react';
import { useAppDispatch } from '@/store/hooks';
import { setUserImage, setClothingImage, setError } from '@/store/slices/tryonSlice';
import { imageService } from '@/services/image';

export const useImageUpload = () => {
  const dispatch = useAppDispatch();
  const [uploading, setUploading] = useState(false);

  const uploadImage = useCallback(async (file: File, type: 'user' | 'clothing') => {
    setUploading(true);
    
    try {
      // 验证图像
      const validation = await imageService.validateImage(file, type);
      if (!validation.valid) {
        throw new Error(validation.error);
      }

      // 上传图像
      const result = await imageService.uploadImage(file, type);
      
      // 更新状态
      if (type === 'user') {
        dispatch(setUserImage(result.imageUrl));
      } else {
        dispatch(setClothingImage(result.imageUrl));
      }

      return result;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : '上传失败';
      dispatch(setError(errorMessage));
      throw error;
    } finally {
      setUploading(false);
    }
  }, [dispatch]);

  return {
    uploadImage,
    uploading
  };
};
```

### 5.2 试衣结果Hook

```typescript
// hooks/useTryOnResult.ts
import { useState, useCallback } from 'react';
import { useAppSelector, useAppDispatch } from '@/store/hooks';
import { setProcessing, setProgress, setResultImage, setError, addToHistory } from '@/store/slices/tryonSlice';
import { tryonService } from '@/services/tryon';

export const useTryOnResult = () => {
  const dispatch = useAppDispatch();
  const { userImage, clothingImage, aiSettings, backgroundType } = useAppSelector(state => state.tryon);
  const [processing, setProcessingState] = useState(false);

  const generateResult = useCallback(async () => {
    if (!userImage || !clothingImage) {
      throw new Error('请先上传用户照片和服装图片');
    }

    dispatch(setProcessing(true));
    setProcessingState(true);

    try {
      const result = await tryonService.generateTryOnResult(
        {
          userImage,
          clothingImage,
          aiSettings,
          backgroundType
        },
        (progress) => {
          dispatch(setProgress(progress));
        }
      );

      dispatch(setResultImage(result.imageUrl));
      
      // 添加到历史记录
      dispatch(addToHistory({
        id: Date.now().toString(),
        userImage,
        clothingImage,
        resultImage: result.imageUrl,
        createdAt: new Date().toISOString(),
        aiSettings
      }));

      return result;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : '生成失败';
      dispatch(setError(errorMessage));
      throw error;
    } finally {
      dispatch(setProcessing(false));
      setProcessingState(false);
    }
  }, [userImage, clothingImage, aiSettings, backgroundType, dispatch]);

  const downloadResult = useCallback(async (sessionId: string) => {
    try {
      const response = await tryonService.downloadResult(sessionId);
      
      // 创建下载链接
      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `tryon-result-${sessionId}.jpg`);
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
    } catch (error) {
      throw new Error('下载失败');
    }
  }, []);

  return {
    generateResult,
    downloadResult,
    processing,
    canGenerate: !!(userImage && clothingImage && !processing)
  };
};
```

## 6. 后端API实现

### 6.1 试衣控制器

```typescript
// controllers/tryonController.ts
import { Request, Response } from 'express';
import { tryonService } from '../services/tryonService';
import { validationResult } from 'express-validator';

export class TryOnController {
  // 生成试衣结果
  async generateTryOnResult(req: Request, res: Response) {
    try {
      const errors = validationResult(req);
      if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
      }

      const { userImage, clothingImage, aiSettings, backgroundType } = req.body;
      const userId = req.user?.id;

      const sessionId = await tryonService.createTryOnSession({
        userId,
        userImage,
        clothingImage,
        aiSettings,
        backgroundType
      });

      // 异步处理试衣生成
      tryonService.processTryOnSession(sessionId).catch(console.error);

      res.json({
        sessionId,
        status: 'processing',
        message: '试衣处理已开始'
      });
    } catch (error) {
      console.error('生成试衣结果失败:', error);
      res.status(500).json({ error: '服务器内部错误' });
    }
  }

  // 获取处理状态
  async getProcessingStatus(req: Request, res: Response) {
    try {
      const { sessionId } = req.params;
      const status = await tryonService.getSessionStatus(sessionId);
      
      res.json(status);
    } catch (error) {
      console.error('获取处理状态失败:', error);
      res.status(500).json({ error: '服务器内部错误' });
    }
  }

  // 获取试衣历史
  async getTryOnHistory(req: Request, res: Response) {
    try {
      const userId = req.user?.id;
      const { page = 1, limit = 10 } = req.query;
      
      const history = await tryonService.getUserTryOnHistory(
        userId,
        parseInt(page as string),
        parseInt(limit as string)
      );

      res.json(history);
    } catch (error) {
      console.error('获取试衣历史失败:', error);
      res.status(500).json({ error: '服务器内部错误' });
    }
  }

  // 下载试衣结果
  async downloadResult(req: Request, res: Response) {
    try {
      const { sessionId } = req.params;
      const userId = req.user?.id;
      
      const result = await tryonService.getTryOnResult(sessionId, userId);
      if (!result) {
        return res.status(404).json({ error: '结果不存在' });
      }

      res.setHeader('Content-Type', 'image/jpeg');
      res.setHeader('Content-Disposition', `attachment; filename="tryon-${sessionId}.jpg"`);
      res.send(result.imageBuffer);
    } catch (error) {
      console.error('下载试衣结果失败:', error);
      res.status(500).json({ error: '服务器内部错误' });
    }
  }
}
```

### 6.2 AI服务实现

```typescript
// services/aiService.ts
import { spawn } from 'child_process';
import path from 'path';
import fs from 'fs/promises';

export class AIService {
  private pythonScriptPath: string;
  private modelPath: string;

  constructor() {
    this.pythonScriptPath = path.join(__dirname, '../ai/process_tryon.py');
    this.modelPath = path.join(__dirname, '../ai/models');
  }

  // 处理试衣生成
  async processTryOn(params: {
    userImagePath: string;
    clothingImagePath: string;
    outputPath: string;
    aiSettings: {
      fittingStyle: string;
      effectIntensity: string;
    };
    backgroundType?: string;
  }): Promise<{ success: boolean; error?: string }> {
    return new Promise((resolve) => {
      const pythonProcess = spawn('python3', [
        this.pythonScriptPath,
        '--user-image', params.userImagePath,
        '--clothing-image', params.clothingImagePath,
        '--output', params.outputPath,
        '--fitting-style', params.aiSettings.fittingStyle,
        '--effect-intensity', params.aiSettings.effectIntensity,
        ...(params.backgroundType ? ['--background', params.backgroundType] : [])
      ]);

      let errorOutput = '';

      pythonProcess.stderr.on('data', (data) => {
        errorOutput += data.toString();
      });

      pythonProcess.on('close', (code) => {
        if (code === 0) {
          resolve({ success: true });
        } else {
          resolve({ success: false, error: errorOutput });
        }
      });

      pythonProcess.on('error', (error) => {
        resolve({ success: false, error: error.message });
      });
    });
  }

  // 验证图像质量
  async validateImage(imagePath: string, type: 'user' | 'clothing'): Promise<{
    valid: boolean;
    error?: string;
    warnings?: string[];
  }> {
    try {
      const pythonProcess = spawn('python3', [
        path.join(__dirname, '../ai/validate_image.py'),
        '--image', imagePath,
        '--type', type
      ]);

      let output = '';
      let errorOutput = '';

      pythonProcess.stdout.on('data', (data) => {
        output += data.toString();
      });

      pythonProcess.stderr.on('data', (data) => {
        errorOutput += data.toString();
      });

      return new Promise((resolve) => {
        pythonProcess.on('close', (code) => {
          if (code === 0) {
            try {
              const result = JSON.parse(output);
              resolve(result);
            } catch {
              resolve({ valid: false, error: '验证结果解析失败' });
            }
          } else {
            resolve({ valid: false, error: errorOutput || '图像验证失败' });
          }
        });
      });
    } catch (error) {
      return { valid: false, error: '验证过程出错' };
    }
  }
}
```

## 7. 部署配置

### 7.1 Docker配置

```dockerfile
# Dockerfile
FROM node:18-alpine AS frontend-build

WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci --only=production

COPY frontend/ ./
RUN npm run build

FROM node:18-alpine AS backend-build

WORKDIR /app/backend
COPY backend/package*.json ./
RUN npm ci --only=production

COPY backend/ ./
RUN npm run build

FROM python:3.9-slim AS ai-service

WORKDIR /app/ai
COPY ai/requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

COPY ai/ ./

FROM node:18-alpine AS production

WORKDIR /app

# 安装系统依赖
RUN apk add --no-cache python3 py3-pip

# 复制后端代码
COPY --from=backend-build /app/backend/dist ./backend
COPY --from=backend-build /app/backend/node_modules ./backend/node_modules
COPY --from=backend-build /app/backend/package.json ./backend/

# 复制前端构建结果
COPY --from=frontend-build /app/frontend/dist ./frontend

# 复制AI服务
COPY --from=ai-service /app/ai ./ai
COPY --from=ai-service /usr/local/lib/python3.9/site-packages /usr/local/lib/python3.9/site-packages

# 设置环境变量
ENV NODE_ENV=production
ENV PORT=3000

EXPOSE 3000

CMD ["node", "backend/server.js"]
```

### 7.2 Kubernetes部署配置

```yaml
# k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tryon-app
  labels:
    app: tryon-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: tryon-app
  template:
    metadata:
      labels:
        app: tryon-app
    spec:
      containers:
      - name: tryon-app
        image: tryon-app:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: tryon-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: tryon-secrets
              key: redis-url
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: tryon-service
spec:
  selector:
    app: tryon-app
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: LoadBalancer
```

---

*本技术实现指南提供了AI虚拟试衣应用的完整技术实现方案，包括前端组件、后端API、状态管理、AI服务集成和部署配置等核心内容。*
