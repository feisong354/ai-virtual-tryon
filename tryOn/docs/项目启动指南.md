# AI虚拟试衣应用 - 项目启动指南

## 1. 环境准备

### 1.1 开发环境要求
- **Node.js**: 18.x 或更高版本
- **Python**: 3.9 或更高版本
- **数据库**: PostgreSQL 14+ 和 Redis 6+
- **包管理器**: npm 或 yarn
- **版本控制**: Git

### 1.2 开发工具推荐
- **IDE**: VS Code 或 WebStorm
- **浏览器**: Chrome 或 Firefox (支持最新特性)
- **API测试**: Postman 或 Insomnia
- **数据库管理**: pgAdmin 或 DBeaver

## 2. 项目初始化

### 2.1 创建项目目录结构

```bash
# 创建项目根目录
mkdir ai-virtual-tryon
cd ai-virtual-tryon

# 创建子项目目录
mkdir frontend backend ai-scripts docs
```

### 2.2 前端项目初始化

```bash
cd frontend

# 使用 Vite 创建 React + TypeScript 项目
npm create vite@latest . -- --template react-ts

# 安装依赖
npm install

# 安装额外依赖
npm install @reduxjs/toolkit react-redux
npm install react-dropzone
npm install tailwindcss @tailwindcss/forms
npm install @headlessui/react @heroicons/react
npm install axios
npm install fabric
npm install -D @types/fabric

# 初始化 Tailwind CSS
npx tailwindcss init -p
```

### 2.3 后端项目初始化

```bash
cd ../backend

# 初始化 Node.js 项目
npm init -y

# 安装依赖
npm install express cors helmet morgan
npm install jsonwebtoken bcryptjs
npm install multer sharp
npm install pg redis
npm install express-validator
npm install dotenv
npm install bull
npm install swagger-jsdoc swagger-ui-express

# 安装开发依赖
npm install -D @types/node @types/express @types/cors
npm install -D @types/jsonwebtoken @types/bcryptjs
npm install -D @types/multer @types/pg
npm install -D typescript ts-node nodemon
npm install -D jest @types/jest supertest @types/supertest

# 初始化 TypeScript
npx tsc --init
```

### 2.4 AI服务初始化

```bash
cd ../ai-scripts

# 创建 Python 虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或 venv\Scripts\activate  # Windows

# 安装依赖
pip install torch torchvision
pip install opencv-python pillow
pip install mediapipe
pip install numpy scipy
pip install tensorflow
pip install flask
```

## 3. 配置文件设置

### 3.1 前端配置

```typescript
// frontend/vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      },
    },
  },
})
```

```css
/* frontend/tailwind.config.js */
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        'tech-blue': '#3498db',
        'tech-dark': '#2c3e50',
        'light-gray': '#f5f7fa',
        'medium-gray': '#e2e8f0',
      },
      fontFamily: {
        'sans': ['Noto Sans SC', 'system-ui', 'sans-serif'],
      },
    },
  },
  plugins: [
    require('@tailwindcss/forms'),
  ],
}
```

### 3.2 后端配置

```typescript
// backend/src/config/database.ts
import { Pool } from 'pg';

export const dbConfig = {
  user: process.env.DB_USER || 'postgres',
  host: process.env.DB_HOST || 'localhost',
  database: process.env.DB_NAME || 'tryon_db',
  password: process.env.DB_PASSWORD || 'password',
  port: parseInt(process.env.DB_PORT || '5432'),
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
};

export const pool = new Pool(dbConfig);
```

```typescript
// backend/src/config/redis.ts
import Redis from 'ioredis';

export const redis = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: parseInt(process.env.REDIS_PORT || '6379'),
  password: process.env.REDIS_PASSWORD,
  retryDelayOnFailover: 100,
  maxRetriesPerRequest: 3,
});
```

### 3.3 环境变量配置

```bash
# backend/.env
NODE_ENV=development
PORT=3001
JWT_SECRET=your-jwt-secret-key
DB_USER=postgres
DB_HOST=localhost
DB_NAME=tryon_db
DB_PASSWORD=password
DB_PORT=5432
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760
AI_SERVICE_URL=http://localhost:5000
```

```bash
# frontend/.env
VITE_API_BASE_URL=http://localhost:3001/api
VITE_APP_NAME=StyleAI
```

## 4. 数据库设置

### 4.1 PostgreSQL 数据库创建

```sql
-- 创建数据库
CREATE DATABASE tryon_db;

-- 创建用户
CREATE USER tryon_user WITH PASSWORD 'tryon_password';
GRANT ALL PRIVILEGES ON DATABASE tryon_db TO tryon_user;

-- 连接到数据库
\c tryon_db;

-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 创建表结构
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    avatar_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE tryon_sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id),
    user_image_url VARCHAR(500) NOT NULL,
    clothing_image_url VARCHAR(500) NOT NULL,
    result_image_url VARCHAR(500),
    background_type VARCHAR(50),
    fitting_style VARCHAR(50),
    effect_intensity VARCHAR(50),
    status VARCHAR(20) DEFAULT 'processing',
    progress INTEGER DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE TABLE background_templates (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) NOT NULL,
    category VARCHAR(50) NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    thumbnail_url VARCHAR(500),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_preferences (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id),
    default_fitting_style VARCHAR(50),
    default_effect_intensity VARCHAR(50),
    preferred_background_category VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_tryon_sessions_user_id ON tryon_sessions(user_id);
CREATE INDEX idx_tryon_sessions_status ON tryon_sessions(status);
CREATE INDEX idx_tryon_sessions_created_at ON tryon_sessions(created_at);
```

### 4.2 Redis 配置

```bash
# 启动 Redis 服务
redis-server

# 测试连接
redis-cli ping
```

## 5. 开发脚本配置

### 5.1 前端开发脚本

```json
// frontend/package.json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "type-check": "tsc --noEmit"
  }
}
```

### 5.2 后端开发脚本

```json
// backend/package.json
{
  "scripts": {
    "dev": "nodemon src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "db:migrate": "node scripts/migrate.js",
    "db:seed": "node scripts/seed.js"
  }
}
```

### 5.3 AI服务脚本

```python
# ai-scripts/requirements.txt
torch>=1.12.0
torchvision>=0.13.0
opencv-python>=4.6.0
pillow>=9.0.0
mediapipe>=0.8.11
numpy>=1.21.0
scipy>=1.8.0
tensorflow>=2.9.0
flask>=2.2.0
requests>=2.28.0
```

## 6. 快速启动命令

### 6.1 一键启动脚本

```bash
#!/bin/bash
# start-dev.sh

echo "启动开发环境..."

# 启动数据库服务
echo "启动 PostgreSQL..."
brew services start postgresql

echo "启动 Redis..."
brew services start redis

# 启动后端服务
echo "启动后端服务..."
cd backend
npm run dev &
BACKEND_PID=$!

# 启动AI服务
echo "启动AI服务..."
cd ../ai-scripts
source venv/bin/activate
python app.py &
AI_PID=$!

# 启动前端服务
echo "启动前端服务..."
cd ../frontend
npm run dev &
FRONTEND_PID=$!

echo "所有服务已启动!"
echo "前端: http://localhost:3000"
echo "后端: http://localhost:3001"
echo "AI服务: http://localhost:5000"

# 等待用户中断
trap "kill $BACKEND_PID $AI_PID $FRONTEND_PID; exit" INT
wait
```

### 6.2 Docker Compose 启动

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: tryon_db
      POSTGRES_USER: tryon_user
      POSTGRES_PASSWORD: tryon_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - DB_HOST=postgres
      - REDIS_HOST=redis
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      - postgres
      - redis

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend

volumes:
  postgres_data:
  redis_data:
```

## 7. 开发工作流

### 7.1 Git 工作流

```bash
# 创建功能分支
git checkout -b feature/image-upload

# 开发完成后提交
git add .
git commit -m "feat: 实现图像上传功能"

# 推送到远程
git push origin feature/image-upload

# 创建 Pull Request
```

### 7.2 代码规范

```json
// .eslintrc.js
module.exports = {
  extends: [
    'eslint:recommended',
    '@typescript-eslint/recommended',
    'plugin:react/recommended',
    'plugin:react-hooks/recommended',
  ],
  rules: {
    'react/react-in-jsx-scope': 'off',
    '@typescript-eslint/no-unused-vars': 'error',
    'prefer-const': 'error',
  },
}
```

```json
// .prettierrc
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2
}
```

## 8. 测试配置

### 8.1 前端测试

```typescript
// frontend/src/components/__tests__/ImageUpload.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { ImageUpload } from '../ImageUpload';

describe('ImageUpload', () => {
  it('renders upload area correctly', () => {
    render(<ImageUpload type="user" onUploadSuccess={jest.fn()} onUploadError={jest.fn()} />);
    
    expect(screen.getByText('上传人物照片')).toBeInTheDocument();
    expect(screen.getByText('选择文件')).toBeInTheDocument();
  });

  it('handles file drop correctly', () => {
    const onUploadSuccess = jest.fn();
    render(<ImageUpload type="user" onUploadSuccess={onUploadSuccess} onUploadError={jest.fn()} />);
    
    // 测试文件拖拽功能
    const file = new File(['test'], 'test.jpg', { type: 'image/jpeg' });
    const input = screen.getByRole('button', { name: /选择文件/i });
    
    fireEvent.change(input, { target: { files: [file] } });
    
    // 验证上传成功回调被调用
    expect(onUploadSuccess).toHaveBeenCalled();
  });
});
```

### 8.2 后端测试

```typescript
// backend/src/controllers/__tests__/tryonController.test.ts
import request from 'supertest';
import { app } from '../../app';

describe('TryOn Controller', () => {
  it('should create tryon session', async () => {
    const response = await request(app)
      .post('/api/tryon/generate')
      .send({
        userImage: 'test-user-image.jpg',
        clothingImage: 'test-clothing-image.jpg',
        aiSettings: {
          fittingStyle: 'standard',
          effectIntensity: 'enhanced'
        }
      })
      .expect(200);

    expect(response.body.sessionId).toBeDefined();
    expect(response.body.status).toBe('processing');
  });
});
```

## 9. 部署准备

### 9.1 生产环境配置

```bash
# backend/.env.production
NODE_ENV=production
PORT=3001
JWT_SECRET=your-production-jwt-secret
DB_HOST=your-production-db-host
DB_NAME=tryon_db_prod
DB_PASSWORD=your-production-db-password
REDIS_HOST=your-production-redis-host
REDIS_PASSWORD=your-production-redis-password
UPLOAD_DIR=/app/uploads
MAX_FILE_SIZE=10485760
AI_SERVICE_URL=http://ai-service:5000
```

### 9.2 构建脚本

```bash
#!/bin/bash
# build.sh

echo "构建生产版本..."

# 构建前端
cd frontend
npm run build
cd ..

# 构建后端
cd backend
npm run build
cd ..

# 构建Docker镜像
docker build -t tryon-app:latest .

echo "构建完成!"
```

## 10. 常见问题解决

### 10.1 开发环境问题

**问题**: 前端无法连接到后端API
**解决**: 检查 `vite.config.ts` 中的代理配置，确保后端服务正在运行

**问题**: 数据库连接失败
**解决**: 检查 PostgreSQL 服务是否启动，验证连接参数

**问题**: AI服务启动失败
**解决**: 检查 Python 虚拟环境是否正确激活，依赖是否完整安装

### 10.2 性能优化

**问题**: 图像上传速度慢
**解决**: 实现图像压缩和分片上传

**问题**: AI处理时间长
**解决**: 使用GPU加速，实现异步处理和进度反馈

**问题**: 内存占用过高
**解决**: 优化图像处理流程，及时释放资源

---

*本启动指南提供了完整的项目初始化、配置和开发流程，帮助您快速开始AI虚拟试衣应用的开发工作。*
